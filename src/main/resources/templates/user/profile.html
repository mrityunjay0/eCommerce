<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::layout(~{::section})}">
<head>
    <meta charset="ISO-8859-1">
    <title>My Profile</title>
</head>
<body>
<section>
    <div class="container-fluid mt-2 p-5 bg-light">
        <div class="row">
            <div class="col-md-10 offset-md-1">

                <p class="fs-3 text-center">My Profile</p>

                <!-- SUCCESS MESSAGE -->
                <div th:if="${session.successMsg}"
                     class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 w-50 shadow"
                     role="alert" style="z-index:2000;">
                    [[${session.successMsg}]]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
                </div>

                <!-- ERROR MESSAGE -->
                <div th:if="${session.errorMsg}"
                     class="alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 w-50 shadow"
                     role="alert" style="z-index:2000;">
                    [[${session.errorMsg}]]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
                </div>

                <hr>

                <!-- Avatar -->
                <div class="text-center">
                    <img alt="Profile picture"
                         th:src="@{${user.profileImage} != null ? '/img/profile_img/' + ${user.profileImage} : '/img/profile_img/default.png'}"
                         class="border p-2 object-fit-cover"
                         style="width:110px;height:110px;border-radius:50%;">
                </div>

                <!-- Profile form -->
                <div class="col-md-8 offset-md-2 mt-4">
                    <form action="/user/updateProfile"
                          method="post"
                          enctype="multipart/form-data"
                          th:object="${user}"
                          onsubmit="return confirm('Are you sure you want to update your profile?');"
                          id="profileForm">

                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" th:field="*{id}">

                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input id="name" th:field="*{name}" type="text" class="form-control editable-field" maxlength="80" autocomplete="name" disabled>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Mobile Number</label>
                            <input id="phone" th:field="*{phone}" type="tel" class="form-control editable-field"
                                   pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" disabled>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input id="email" th:field="*{email}" type="email" class="form-control" autocomplete="email" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input id="address" th:field="*{address}" type="text" class="form-control editable-field" autocomplete="street-address" disabled>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="city" class="form-label">City</label>
                                <input id="city" th:field="*{city}" type="text" class="form-control editable-field" disabled>
                            </div>
                            <div class="col-md-4">
                                <label for="state" class="form-label">State</label>
                                <input id="state" th:field="*{state}" type="text" class="form-control editable-field" disabled>
                            </div>
                            <div class="col-md-2">
                                <label for="pincode" class="form-label">Pincode</label>
                                <input id="pincode" th:field="*{pincode}" type="text" class="form-control editable-field"
                                       pattern="[0-9]{5,6}" inputmode="numeric" disabled>
                            </div>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label">Profile Image</label>
                            <input id="profileImage" name="file" type="file" class="form-control editable-field"
                                   required accept="image/*" disabled>
                            <small class="text-muted">Max ~2MB. JPG/PNG recommended.</small>
                        </div>

                        <div class="text-center mt-3">
                            <button type="button" id="editBtn" class="btn btn-outline-primary btn-sm"
                                    onclick="enterEdit()">Edit Profile</button>
                            <button type="submit" id="updateBtn" class="btn btn-primary btn-sm px-4 d-none">Update</button>
                            <button type="button" id="cancelBtn" class="btn btn-secondary btn-sm px-4 d-none"
                                    onclick="exitEdit(true)">Cancel</button>
                        </div>
                    </form>
                </div>

            </div>

            <hr class="mt-4">

            <!-- Change Password -->
            <div class="col-md-10 offset-md-1 mt-1">
                <div class="row">
                    <p class="text-center fs-3">Change Password</p>
                    <div class="col-md-6 offset-md-3">
                        <form action="/user/changePassword" method="post" novalidate>
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input id="currentPassword" name="currentPassword" type="password" class="form-control"
                                       autocomplete="current-password" required>
                            </div>

                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input id="newPassword" name="newPassword" type="password" class="form-control"
                                       minlength="8" autocomplete="new-password" required>
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <input id="confirmPassword" name="confirmPassword" type="password" class="form-control"
                                       minlength="8" autocomplete="new-password" required>
                            </div>

                            <div class="text-center">
                                <button onclick="return confirm('Are you sure you want to update the profile?')"
                                        class="btn btn-primary btn-sm col-md-4">Update</button>
                            </div>
                        </form>
                        <small class="text-muted d-block mt-2">Tip: use at least 8 characters with a mix of letters, numbers and symbols.</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // expose globally so onclick="" can call them
        window.enterEdit = function () {
          const fields    = Array.from(document.querySelectorAll('.editable-field'));
          const editBtn   = document.getElementById('editBtn');
          const updateBtn = document.getElementById('updateBtn');
          const cancelBtn = document.getElementById('cancelBtn');
          const fileInput = document.getElementById('profileImage') || document.querySelector('input[name="file"]');

          // store originals on form to restore on cancel
          const form = document.getElementById('profileForm');
          form._originals = new Map();
          fields.forEach(f => {
            form._originals.set(f.id || f.name, f.value);
            f.removeAttribute('disabled');
          });
          if (fileInput) fileInput.value = '';

          editBtn.classList.add('d-none');
          updateBtn.classList.remove('d-none');
          cancelBtn.classList.remove('d-none');
        };

        window.exitEdit = function (restore) {
          const fields    = Array.from(document.querySelectorAll('.editable-field'));
          const editBtn   = document.getElementById('editBtn');
          const updateBtn = document.getElementById('updateBtn');
          const cancelBtn = document.getElementById('cancelBtn');
          const form      = document.getElementById('profileForm');

          if (restore && form && form._originals) {
            fields.forEach(f => {
              const key = f.id || f.name;
              if (form._originals.has(key)) f.value = form._originals.get(key);
            });
            const fileInput = document.getElementById('profileImage') || document.querySelector('input[name="file"]');
            if (fileInput) fileInput.value = '';
          }

          fields.forEach(f => f.setAttribute('disabled', 'true'));
          updateBtn.classList.add('d-none');
          cancelBtn.classList.add('d-none');
          editBtn.classList.remove('d-none');
        };
    </script>

</section>

</body>
</html>